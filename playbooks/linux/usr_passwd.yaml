---
- name: Create a new user with random password
  hosts: linux
  gather_facts: yes
  tasks:
    - name: Generate a random username
      set_fact:
        random_username: "user{{ ansible_uuid.split('-')[4] }}"

    - name: Generate a random password
      set_fact:
        random_password: "{{ lookup('password', '/dev/null length=12 chars=ascii_letters,digits') }}"

    - name: Check if the user already exists
      command: "id {{ random_username }}"
      ignore_errors: true
      register: user_exists_result

    - name: Create a new user
      user:
        name: "{{ random_username }}"
        password: "{{ random_password | password_hash('sha512') }}"
        state: present

    - name: Save username and password to password.txt file
      lineinfile:
        path: password.txt
        line: "{{ random_username }}:{{ random_password }}"
        create: yes
