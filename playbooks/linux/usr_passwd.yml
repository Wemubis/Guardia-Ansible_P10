---
- name: Create or update user with random password
  hosts: linux

  tasks:
    - name: Check if the user exists
      command: "id {{ username }}"
      register: user_exists
      ignore_errors: true

    - name: Generate a random password
      set_fact:
        random_password: "{{ lookup('password', '/dev/null length=12 chars=ascii_letters,digits') }}"

    - name: Create or update user
      user:
        name: "{{ username }}"
        password: "{{ random_password | password_hash('sha512') }}"
        state: present
        update_password: always

    - name: Check if password file exists
      stat:
        path: "{{ pwd_file }}"
      register: pwd_file_stat

    - name: Create password file if it doesn't exist
      file:
        path: "{{ pwd_file }}"
        state: touch
        mode: '0644'
      when: user_exists.rc == 0 and not pwd_file_stat.stat.exists

    - name: Save username and password to password file
      blockinfile:
        path: "{{ pwd_file }}"
        block: |
          Username: {{ username }}
          Password: {{ random_password }}
        create: yes
        state: present
